---
title: "import_data"
author: "Lucky Mehra"
date: "6/14/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r package-install}
if (!require(pacman)){
	install.packages("pacman")
}

# packages needed for this project
pacman::p_load(tidyverse,
							 readxl, 
							 openxlsx,
							 readODS,
							 here,
							 rlang,
							 glue,
							 Hmisc,
							 caret,
							 MASS,
							 nasapower, # for preharvest weather data
							 weatherData,
							 lubridate # to handle dates and times
							 )

pacman::p_load_gh("Ram-N/weatherData")
library(weatherData)
```

Import `SRS 2017 FOR SAS.ods` since this has daily averages of weather data instead of every 30 minutes in `SRS 2017 FOR R.ods`.

```{r data-import}

# import necrosis data ----

# 2017
necrosis17 <- read_ods(here("data/raw", "SRS 2017 FOR SAS.ods")) %>% 
	
	gather(key = "Root", value = "necrosis_level", `Root 1`:`Root 30`) %>% 
	
	group_by(Facility, Grower, Stack, Harvest, Cut) %>% 
	
	summarise(incidence = sum(necrosis_level > 1, na.rm = TRUE) / n()) %>% 
	
	ungroup()

# spread the necrosis data and cacluate average incidence across cuts
necrosis17_wide <- necrosis17 %>% 
	
	spread(key = Cut, value = incidence) %>% 
	
	rename(cut1_in = `1`,
				 cut2_in = `2`,
				 cut3_in = `3`,
				 cut4_in = `4`) %>% 
	
	mutate(mean_in = dplyr::select(., cut1_in:cut4_in) %>% 
				 	as.matrix() %>% 
				 	rowMeans(na.rm = TRUE),
				 
				 mean_in2to4 = dplyr::select(., cut2_in:cut4_in) %>% 
				 	as.matrix() %>% 
				 	rowMeans(na.rm = TRUE),
				 
				 Year = 2017)

# import weather data	----

# 2016
weather16 <- read_ods(here("data/raw", "SRS 2016 all facilities 30 days avg.ods")) %>% 
	
	fill(Facility, Grower) %>% 
	
	na.omit() %>% 
	
	mutate(Date = lubridate::mdy(Date),
				 Year = 2016)

# 2017
weather17 <- read_ods(here("data/raw", "SRS 2017 FOR SAS.ods"), sheet = 2) %>% 
	
	na.omit() %>% 
	
	mutate(Date = lubridate::mdy(Date),
				 Year = 2017)

# combined weather data of 2016 and 2017
weather <- bind_rows(weather16, weather17)
```

Import pre-harvest weather data based on grower field locations.  

```{r pre-harvest-weather}
# use  `GSODR` package  
install.packages("GSODR")
library(GSODR) 

get_weather <- function(lat, lon, harvest_date, i, facility) {
	get_GSOD(years = year({{harvest_date}}), station = nearest_stations(LAT = {{lat}},
  																																	LON = {{lon}},
  																																	distance = 50)[i]) %>% 
  dplyr::select(LAT, LON, YEARMODA, TEMP, MAX, MIN, PRCP, RH) %>% 
  filter(between(ymd(YEARMODA),ymd({{harvest_date}}) - 29, ymd({{harvest_date}}))) %>% 
		mutate(Facility = {{facility}})
}

# 2016 preharvest weather
u_16_h1 <- get_weather(35.38, -78.33, "2016-10-17", 3, "U")
v_16_h1 <- get_weather(35.02, -78.28, "2016-10-17", 3, "V")
w_16_h1 <- get_weather(35.35, -77.97, "2016-10-17", 1, "W")
x_16_h1 <- get_weather(35.02, -78.28, "2016-10-17", 3, "X")
y_16_h1 <- get_weather(35.30, -77.57, "2016-10-17", 4, "Y")
z_16_h1 <- get_weather(35.02, -78.28, "2016-10-17", 3, "Z")

pre_weather_16 <- bind_rows(u_16_h1, v_16_h1, w_16_h1,
														x_16_h1, y_16_h1, z_16_h1)
# 2017 preharvest weather
u_17_h1 <- get_weather(35.35, -77.97, "2017-09-14", 1, "U")

```

Make new weather variables for different time windows. These time windows are 1 to 7 days after harvest, 1 to 14 days after harvest, 1 to 21 days after harvest, and 1 to 30 days after harvest. Below, I am creating a function that can be easily used to create same weather variables for different window panes (aka time frames after harvesting).  

```{r weather-variables}
# make new weather variables
create_weather_vars <- function(days_after_harvest = 7){

	weather17 %>% 

	group_by(Facility, Grower, Harvest) %>% 
	
	filter(Date < Date[1] + {{days_after_harvest}}) %>%
	
	summarise(!!paste0("duration_", {{days_after_harvest}}) := n(),
						!!paste0("max_temp_avg_", {{days_after_harvest}}) := mean(`Max Temp`, na.rm = TRUE),
						!!paste0("min_temp_avg_", {{days_after_harvest}}) := mean(`Min Temp`, na.rm = TRUE),
						!!paste0("avg_temp_", {{days_after_harvest}}) := mean(`Avg Temp`, na.rm = TRUE),
						!!paste0("diff_max_avg_", {{days_after_harvest}}) := max(`Max Temp`) - mean(`Avg Temp`, na.rm = TRUE),
						!!paste0("max_RH_avg_", {{days_after_harvest}}) := mean(`Max RH`, na.rm = TRUE),
						!!paste0("min_RH_avg_", {{days_after_harvest}}) := mean(`Min RH`, na.rm = TRUE),
						!!paste0("avg_RH_", {{days_after_harvest}}) := mean(`Avg RH`, na.rm = TRUE),
						
						!!paste0("daysTA60_", {{days_after_harvest}}) := sum(`Min Temp` >= 60), # TA = Temperature Above
						!!paste0("daysTA65_", {{days_after_harvest}}) := sum(`Min Temp` >= 65),
						!!paste0("daysTA70_", {{days_after_harvest}}) := sum(`Min Temp` >= 70),
						!!paste0("daysTA75_", {{days_after_harvest}}) := sum(`Min Temp` >= 75),
						!!paste0("daysTA80_", {{days_after_harvest}}) := sum(`Min Temp` >= 80),
						!!paste0("daysTA85_", {{days_after_harvest}}) := sum(`Min Temp` >= 85),
						
						!!paste0("daysTB60_", {{days_after_harvest}}) := sum(`Max Temp` < 60), # TB = Temperature Below
						
						!!paste0("daysRHB60_", {{days_after_harvest}}) := sum(`Max RH` < 60), # RHB = Relative Humidity Below
						!!paste0("daysRHB65_", {{days_after_harvest}}) := sum(`Max RH` < 65),
						!!paste0("daysRHB70_", {{days_after_harvest}}) := sum(`Max RH` < 70),
						!!paste0("daysRHB75_", {{days_after_harvest}}) := sum(`Max RH` < 75),
						!!paste0("daysRHB80_", {{days_after_harvest}}) := sum(`Max RH` < 80),
						!!paste0("daysRHB85_", {{days_after_harvest}}) := sum(`Max RH` < 85),
						!!paste0("daysRHB90_", {{days_after_harvest}}) := sum(`Max RH` < 90),
						!!paste0("daysRHB95_", {{days_after_harvest}}) := sum(`Max RH` < 95)
						) %>% 
		ungroup()
}

weather17_vars_1to7dah <- create_weather_vars(days_after_harvest = 7)
weather17_vars_1to14dah <- create_weather_vars(days_after_harvest = 14)
weather17_vars_1to21dah <- create_weather_vars(days_after_harvest = 21)
weather17_vars_1to30dah <- create_weather_vars(days_after_harvest = 30)

# all weather variables in one data frame
weather17_vars <- inner_join(weather17_vars_1to7dah, weather17_vars_1to14dah) %>% 
	
	inner_join(weather17_vars_1to21dah) %>% 
	inner_join(weather17_vars_1to30dah)

```

And, finally join disease incidence data from each facility, grower, and harvest with weather variables to caclulate correlation coefficients.  

```{r join-disease-weather}
int_nec <- inner_join(necrosis17_wide,
											weather17_vars, 
											by = c("Facility", "Grower", "Harvest"))

saveRDS(int_nec, here("data/tidy", "int_nec.Rds"))
```